#!/usr/bin/env ruby
require 'bundler/setup'
require_relative '../lib/crystal'
include Crystal

o_flag = ARGV.length == 0 ? '' : "-o #{File.basename(ARGV[0], File.extname(ARGV[0]))}"

begin
  mod = build ARGF.read
rescue Exception => ex
  puts ex.message
  exit 1
end

reader, writer = IO.pipe
Thread.new do
  mod.write_bitcode(writer)
  writer.close
end

pid = spawn "llc | clang -x assembler #{o_flag} -", in: reader
Process.waitpid pid

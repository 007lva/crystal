#!/bin/bash

function crossCompile() {
  echo "Building $4"
  CMD=`bin/crystal src/compiler/crystal.cr --release --cross-compile="$1" --mcpu="$2" --target="$3" -o crystal-$4`
  vagrant up $5
  echo "Cross compiling crystal-$4"
  vagrant ssh $5 -c "cd crystal; \
    cp /vagrant/crystal-$4.o .; \
    $CMD; \
    cp crystal-$4 /vagrant/crystal-$4"
}

function dist() {
  DIST_DIR=`mktemp -d dist.XXXX`
  mkdir -p $DIST_DIR/crystal/bin
  cp -R libs samples src LICENSE CHANGELOG.md $DIST_DIR/crystal
  cp dist/crystal $DIST_DIR/crystal/bin/crystal
  cp crystal-$1 $DIST_DIR/crystal/bin/crystal-exe

  COPYFILE_DISABLE=1 tar czf crystal-$1-$VERSION.tar.gz -C $DIST_DIR crystal
  rm -Rf $DIST_DIR
}

TAG=`git describe --tags --long | cut -d- -f 1`
VERSION="$TAG"

crossCompile "Linux i686" i686 i686-pc-linux-gnu linux32 precise32
crossCompile "Linux x86_64" x86-64 x86_64-pc-linux-gnu linux64 precise64

echo "Building crystal-darwin"
bin/crystal src/compiler/crystal.cr --release --target="x86_64-apple-darwin13.3.0" --mcpu="x86-64" -o crystal-darwin

echo "Uploading to S3"
for target in darwin linux32 linux64; do
  dist $target
  s3cmd -c ~/.s3cfg-crystal put -P crystal-$target-$VERSION.tar.gz s3://crystal-lang
  s3cmd -c ~/.s3cfg-crystal cp -P s3://crystal-lang/crystal-$target-$VERSION.tar.gz s3://crystal-lang/crystal-$target-latest.tar.gz
done
